<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Memoria de Parejas</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;overflow-x:hidden}
body{font-family:Georgia,serif;background:linear-gradient(135deg,#0a0e27,#1a1034,#2d1b4e);min-height:100vh;color:#e8e8f0;display:flex;flex-direction:column;align-items:center;padding:8px;-webkit-tap-highlight-color:transparent}
.title{font-size:1.4em;background:linear-gradient(135deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.subtitle{color:#d4af37;margin-bottom:6px;font-size:0.8em}
.box{background:rgba(255,255,255,0.05);border:2px solid rgba(212,175,55,0.5);border-radius:12px;padding:10px;width:calc(100% - 16px);max-width:340px}
.hidden{display:none!important}
.banner{background:rgba(255,215,0,0.2);border:1px solid rgba(255,215,0,0.5);color:#ffd700;padding:4px 8px;border-radius:8px;font-size:0.7em}
.back{padding:4px 8px;background:rgba(255,255,255,0.1);border:1px solid rgba(212,175,55,0.3);border-radius:8px;color:#ffd700;text-decoration:none;font-size:0.7em}
.top-bar{width:calc(100% - 16px);max-width:340px;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.popup-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;justify-content:center;align-items:center;z-index:5000;padding:12px}
.popup{background:linear-gradient(135deg,#1a1034,#2d1b4e);border:2px solid rgba(255,215,0,0.3);border-radius:12px;padding:16px;width:90%;max-width:260px;text-align:center}
.popup h3{color:#e8e8f0;margin-bottom:4px;font-size:0.95em}
.popup p{color:#a0a0b8;font-size:0.75em;margin-bottom:12px}
.popup a{display:block;padding:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#e8e8f0;text-decoration:none;margin-bottom:10px;font-size:0.8em}
.popup button{width:100%;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#1a1034;border:none;padding:8px;border-radius:12px;font-weight:bold;cursor:pointer;font-size:0.85em}
.pin-title{color:#ffd700;font-size:1em;text-align:center;margin-bottom:4px}
.pin-sub{color:#b8b8cc;text-align:center;margin-bottom:12px;font-size:0.75em}
.dots{display:flex;justify-content:center;gap:8px;margin-bottom:12px}
.dot{width:12px;height:12px;border-radius:50%;border:2px solid rgba(212,175,55,0.5)}
.dot.on{background:#ffd700;border-color:#ffd700}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;max-width:180px;margin:0 auto 10px}
.key{aspect-ratio:1;font-size:1.1em;border:2px solid rgba(212,175,55,0.3);background:rgba(255,255,255,0.05);color:#e8e8f0;border-radius:6px;cursor:pointer}
.key:active{transform:scale(0.95)}
.key.empty{visibility:hidden}
.msg{text-align:center;min-height:16px;font-size:0.75em}
.msg.err{color:#ff6b6b}
.msg.ok{color:#4ecdc4}
.toggle{text-align:center;margin-top:10px;color:#b8b8cc;font-size:0.75em}
.toggle span{color:#ffd700;cursor:pointer;text-decoration:underline}
.btn{width:100%;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#1a1034;border:none;padding:10px;border-radius:15px;font-size:0.85em;font-weight:bold;cursor:pointer;margin-top:5px}
.btn:active{transform:scale(0.98)}
.btn2{background:linear-gradient(135deg,#8a2be2,#4b0082);color:#fff}
.welcome{background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:8px;padding:10px;margin-bottom:10px;text-align:center}
.welcome h3{color:#ffd700;margin-bottom:2px;font-size:0.95em}
.welcome p{font-size:0.75em;color:#b8b8cc}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin:10px 0}
.stat{background:rgba(255,255,255,0.05);padding:8px;border-radius:6px;text-align:center;border:1px solid rgba(212,175,55,0.2)}
.stat b{display:block;font-size:1.2em;color:#ffd700}
.stat span{color:#b8b8cc;font-size:0.65em}
.game-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:0 5px}
.game-stat{text-align:center}
.game-stat b{display:block;font-size:1.1em;color:#ffd700}
.game-stat span{color:#b8b8cc;font-size:0.65em}
.grid-container{background:rgba(0,0,0,0.3);border-radius:12px;padding:8px;margin:10px 0}
.match-grid{display:grid;gap:6px;max-width:280px;margin:0 auto}
.match-cell{aspect-ratio:1;background:linear-gradient(135deg,#3a3a6a,#2a2a5a);border:2px solid rgba(212,175,55,0.3);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.8em;transition:all 0.3s}
.match-cell.flipped{background:linear-gradient(135deg,#4a4a8a,#3a3a7a);border-color:#ffd700}
.match-cell.matched{background:linear-gradient(135deg,#2a6a4a,#1a5a3a);border-color:#2ecc71}
.match-cell:active{transform:scale(0.95)}
.match-cell.disabled{pointer-events:none}
.res-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:3000;padding:12px}
.res{background:linear-gradient(135deg,#1a1034,#2d1b4e);border:2px solid #ffd700;border-radius:12px;padding:16px 12px;width:90%;max-width:300px;text-align:center}
.res h2{color:#ffd700;margin-bottom:6px;font-size:1.1em}
.res-score{font-size:2.5em;color:#ffd700;font-weight:bold}
.res-label{color:#b8b8cc;margin-bottom:10px;font-size:0.8em}
.res-details{display:flex;justify-content:space-around;margin:10px 0}
.res-detail{text-align:center}
.res-detail b{display:block;color:#ffd700;font-size:1.2em}
.res-detail span{color:#b8b8cc;font-size:0.7em}
.record{background:rgba(255,215,0,0.2);border:1px solid #ffd700;border-radius:5px;padding:6px;margin:8px 0;color:#ffd700;font-weight:bold;font-size:0.85em}
.rating{color:#d4af37;margin-bottom:10px;font-size:0.85em}
</style>
</head>
<body>
<div class="top-bar"><a href="https://hooporiapr-oss.github.io/akashic-works/" class="back">Inicio</a><div class="banner" id="bannerEl">3 gratis</div></div>
<div class="title">Memoria de Parejas</div>
<div class="subtitle">Puerto Rico</div>

<div class="box" id="loginBox">
<div class="pin-title">Ingresa tu PIN</div>
<div class="pin-sub">Escribe tu PIN de 4 dÃ­gitos</div>
<div class="dots"><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div><div class="dot" id="d4"></div></div>
<div class="keypad" id="loginPad"></div>
<div class="msg" id="loginMsg"></div>
<div class="toggle">Â¿No tienes cuenta? <span id="toCreate">Crear PIN</span></div>
</div>

<div class="box hidden" id="createBox">
<div class="pin-title" id="createTitle">Crear PIN</div>
<div class="pin-sub" id="createSub">Escoge un PIN de 4 dÃ­gitos</div>
<div class="dots"><div class="dot" id="c1"></div><div class="dot" id="c2"></div><div class="dot" id="c3"></div><div class="dot" id="c4"></div></div>
<div class="keypad" id="createPad"></div>
<div class="msg" id="createMsg"></div>
<div class="toggle">Â¿Ya tienes PIN? <span id="toLogin">Entrar</span></div>
</div>

<div class="box hidden" id="dashBox">
<div class="welcome"><h3>Â¡Bienvenido!</h3><p>Encuentra las parejas</p></div>
<div class="stats"><div class="stat"><b id="dGames">0</b><span>Juegos</span></div><div class="stat"><b id="dBest">--</b><span>Mejor</span></div><div class="stat"><b id="dAvg">--</b><span>Promedio</span></div><div class="stat"><b id="dRate">--</b><span>Nivel</span></div></div>
<button class="btn" id="startBtn">Comenzar</button>
<button class="btn btn2" id="logoutBtn">Salir</button>
</div>

<div class="box hidden" id="gameBox">
<div class="game-info"><div class="game-stat"><b id="gMoves">0</b><span>Movidas</span></div><div class="game-stat"><b id="gPairs">0/8</b><span>Parejas</span></div><div class="game-stat"><b id="gTime">0:00</b><span>Tiempo</span></div></div>
<div class="grid-container"><div class="match-grid" id="matchGrid"></div></div>
<button class="btn btn2" id="quitBtn">Salir</button>
</div>

<div class="res-bg hidden" id="resBg">
<div class="res">
<h2>Â¡Completado!</h2>
<div class="res-score" id="resMoves">0</div>
<div class="res-label">Movidas</div>
<div class="res-details"><div class="res-detail"><b id="resTime">0:00</b><span>Tiempo</span></div><div class="res-detail"><b id="resPairs">8</b><span>Parejas</span></div></div>
<div class="record hidden" id="resRecord">Â¡Nuevo RÃ©cord!</div>
<div class="rating" id="resRating">Nivel: --</div>
<button class="btn" id="againBtn">Jugar Otra Vez</button>
<button class="btn btn2" id="menuBtn">MenÃº</button>
</div>
</div>

<div class="popup-bg hidden" id="limitPopup">
<div class="popup">
<h3 id="limitTitle">LÃ­mite diario alcanzado</h3>
<p id="limitMsg">Usaste tus 3 juegos gratis hoy</p>
<a href="https://hooporiapr-oss.github.io/akashic-works/">Volver al Inicio</a>
<button id="upgradeBtn">Desbloquear Ilimitado</button>
</div>
</div>

<script>
(function(){
    var PK = "mmpr2_pin";
    var SK = "mmpr2_stats_";
    var DK = "mmpr2_device";
    var MAX_DAILY = 3;
    var MAX_DAYS = 3;
    
    var currentPin = "";
    var moves = 0;
    var pairs = 0;
    var firstCard = null;
    var secondCard = null;
    var canFlip = true;
    var timerInt = null;
    var seconds = 0;
    var cards = [];
    
    var ICONS = ["ðŸŒŸ","ðŸŽ¯","ðŸ”¥","ðŸ’Ž","ðŸŽ¨","ðŸŽ­","ðŸŽª","ðŸŽ¢","ðŸŒˆ","ðŸ¦‹","ðŸŒ¸","ðŸ€"];
    
    function $(id) {
        return document.getElementById(id);
    }
    
    function getDeviceId() {
        var id = localStorage.getItem(DK);
        if (!id) {
            id = "dev_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(DK, id);
        }
        return id;
    }
    
    function getToday() {
        var d = new Date();
        return d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
    }
    
    function getDeviceTries() {
        var key = DK + "_tries";
        try {
            var t = JSON.parse(localStorage.getItem(key));
            if (t && t.startDate) return t;
        } catch (e) {}
        return { n: 0, d: getToday(), startDate: getToday() };
    }
    
    function setDeviceTries(t) {
        localStorage.setItem(DK + "_tries", JSON.stringify(t));
    }
    
    function getDaysDiff(startDate) {
        var start = new Date(startDate);
        var now = new Date();
        return Math.floor((now - start) / (1000 * 60 * 60 * 24));
    }
    
    function canPlay() {
        var t = getDeviceTries();
        var today = getToday();
        var daysSinceStart = getDaysDiff(t.startDate);
        
        if (daysSinceStart >= MAX_DAYS) {
            return { ok: false, left: 0, expired: true, daysLeft: 0 };
        }
        
        if (t.d !== today) {
            t.n = 0;
            t.d = today;
            setDeviceTries(t);
        }
        
        return {
            ok: t.n < MAX_DAILY,
            left: MAX_DAILY - t.n,
            expired: false,
            daysLeft: MAX_DAYS - daysSinceStart
        };
    }
    
    function useTry() {
        var t = getDeviceTries();
        var today = getToday();
        if (t.d !== today) {
            t.n = 0;
            t.d = today;
        }
        t.n++;
        setDeviceTries(t);
        showBanner();
    }
    
    function hash(p) {
        var h = 0;
        var s = p + "mmpr2";
        for (var i = 0; i < s.length; i++) {
            h = ((h << 5) - h) + s.charCodeAt(i);
            h = h & h;
        }
        return h.toString(36);
    }
    
    function getPins() {
        try {
            return JSON.parse(localStorage.getItem(PK)) || {};
        } catch (e) {
            return {};
        }
    }
    
    function savePins(p) {
        localStorage.setItem(PK, JSON.stringify(p));
    }
    
    function checkPin(p) {
        return !!getPins()[hash(p)];
    }
    
    function savePin(p) {
        var pins = getPins();
        pins[hash(p)] = { created: Date.now() };
        savePins(pins);
    }
    
    function getStats() {
        try {
            return JSON.parse(localStorage.getItem(SK + hash(currentPin))) || { games: 0, bestMoves: 0, totalMoves: 0 };
        } catch (e) {
            return { games: 0, bestMoves: 0, totalMoves: 0 };
        }
    }
    
    function setStats(s) {
        localStorage.setItem(SK + hash(currentPin), JSON.stringify(s));
    }
    
    function showBanner() {
        var c = canPlay();
        if (c.expired) {
            $("bannerEl").textContent = "Prueba terminada";
        } else {
            $("bannerEl").textContent = c.left + "/" + MAX_DAILY + " (DÃ­a " + c.daysLeft + ")";
        }
    }
    
    function showLimit() {
        var c = canPlay();
        if (c.expired) {
            $("limitTitle").textContent = "Prueba gratis terminada";
            $("limitMsg").textContent = "Tu prueba gratis de 3 dÃ­as ha expirado";
        } else {
            $("limitTitle").textContent = "LÃ­mite diario alcanzado";
            $("limitMsg").textContent = "Usaste " + MAX_DAILY + " juegos gratis hoy. " + c.daysLeft + " dÃ­a(s) restantes.";
        }
        $("limitPopup").classList.remove("hidden");
    }
    
    function show(id) {
        ["loginBox", "createBox", "dashBox", "gameBox"].forEach(function(x) {
            $(x).classList.add("hidden");
        });
        $(id).classList.remove("hidden");
    }
    
    function setDots(pre, n) {
        for (var i = 1; i <= 4; i++) {
            var el = $(pre + i);
            if (el) {
                if (i <= n) {
                    el.classList.add("on");
                } else {
                    el.classList.remove("on");
                }
            }
        }
    }
    
    function setMsg(id, t, isErr) {
        var m = $(id);
        m.textContent = t;
        m.className = "msg " + (isErr ? "err" : "ok");
    }
    
    function getRating(mv) {
        if (!mv || mv < 1) return "--";
        if (mv <= 16) return "Genio";
        if (mv <= 20) return "Experto";
        if (mv <= 26) return "Excelente";
        if (mv <= 32) return "Bueno";
        return "Aprendiz";
    }
    
    function formatTime(s) {
        return Math.floor(s / 60) + ":" + (s % 60 < 10 ? "0" : "") + (s % 60);
    }
    
    var loginPin = "";
    var createPin = "";
    var confirmPin = "";
    var isConfirming = false;
    
    function buildKeypad(containerId, onDigit, onDelete) {
        var container = $(containerId);
        container.innerHTML = "";
        
        for (var i = 1; i <= 9; i++) {
            (function(digit) {
                var btn = document.createElement("button");
                btn.className = "key";
                btn.textContent = digit;
                btn.onclick = function() { onDigit(digit); };
                container.appendChild(btn);
            })(i);
        }
        
        var empty = document.createElement("button");
        empty.className = "key empty";
        container.appendChild(empty);
        
        var zero = document.createElement("button");
        zero.className = "key";
        zero.textContent = "0";
        zero.onclick = function() { onDigit(0); };
        container.appendChild(zero);
        
        var del = document.createElement("button");
        del.className = "key";
        del.textContent = "â†";
        del.onclick = onDelete;
        container.appendChild(del);
    }
    
    function setupLogin() {
        buildKeypad("loginPad", function(digit) {
            if (loginPin.length < 4) {
                loginPin += digit;
                setDots("d", loginPin.length);
                if (loginPin.length === 4) {
                    setTimeout(function() {
                        if (checkPin(loginPin)) {
                            currentPin = loginPin;
                            loadDash();
                        } else {
                            setMsg("loginMsg", "PIN incorrecto", true);
                            loginPin = "";
                            setDots("d", 0);
                        }
                    }, 200);
                }
            }
        }, function() {
            if (loginPin.length > 0) {
                loginPin = loginPin.slice(0, -1);
                setDots("d", loginPin.length);
                $("loginMsg").textContent = "";
            }
        });
    }
    
    function setupCreate() {
        buildKeypad("createPad", function(digit) {
            if (confirmPin.length < 4) {
                confirmPin += digit;
                setDots("c", confirmPin.length);
                if (confirmPin.length === 4) {
                    setTimeout(function() {
                        if (!isConfirming) {
                            createPin = confirmPin;
                            confirmPin = "";
                            isConfirming = true;
                            $("createTitle").textContent = "Confirmar PIN";
                            $("createSub").textContent = "Escribe el PIN otra vez";
                            setDots("c", 0);
                        } else {
                            if (confirmPin === createPin) {
                                savePin(createPin);
                                currentPin = createPin;
                                setMsg("createMsg", "Â¡PIN creado!", false);
                                setTimeout(loadDash, 500);
                            } else {
                                setMsg("createMsg", "PINs no coinciden", true);
                                createPin = "";
                                confirmPin = "";
                                isConfirming = false;
                                $("createTitle").textContent = "Crear PIN";
                                $("createSub").textContent = "Escoge un PIN de 4 dÃ­gitos";
                                setDots("c", 0);
                            }
                        }
                    }, 200);
                }
            }
        }, function() {
            if (confirmPin.length > 0) {
                confirmPin = confirmPin.slice(0, -1);
                setDots("c", confirmPin.length);
                $("createMsg").textContent = "";
            }
        });
    }
    
    function loadDash() {
        var s = getStats();
        $("dGames").textContent = s.games || 0;
        $("dBest").textContent = s.bestMoves || "--";
        $("dAvg").textContent = s.games > 0 ? Math.round(s.totalMoves / s.games) : "--";
        $("dRate").textContent = getRating(s.bestMoves);
        show("dashBox");
        showBanner();
        if (!canPlay().ok) showLimit();
    }
    
    function shuffle(arr) {
        for (var i = arr.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = arr[i];
            arr[i] = arr[j];
            arr[j] = temp;
        }
        return arr;
    }
    
    function buildGrid() {
        var grid = $("matchGrid");
        grid.innerHTML = "";
        grid.style.gridTemplateColumns = "repeat(4, 1fr)";
        
        var icons = ICONS.slice(0, 8);
        var doubled = icons.concat(icons);
        cards = shuffle(doubled.map(function(icon, idx) {
            return { id: idx, icon: icon, matched: false };
        }));
        
        cards.forEach(function(card, idx) {
            var cell = document.createElement("div");
            cell.className = "match-cell";
            cell.dataset.idx = idx;
            cell.textContent = "";
            cell.onclick = function() { flipCard(idx); };
            grid.appendChild(cell);
        });
    }
    
    function flipCard(idx) {
        if (!canFlip || cards[idx].matched) return;
        
        var cells = $("matchGrid").children;
        var cell = cells[idx];
        
        if (cell.classList.contains("flipped")) return;
        
        cell.classList.add("flipped");
        cell.textContent = cards[idx].icon;
        
        if (!firstCard) {
            firstCard = { idx: idx, icon: cards[idx].icon };
        } else if (firstCard.idx !== idx) {
            secondCard = { idx: idx, icon: cards[idx].icon };
            moves++;
            $("gMoves").textContent = moves;
            canFlip = false;
            
            if (firstCard.icon === secondCard.icon) {
                cards[firstCard.idx].matched = true;
                cards[secondCard.idx].matched = true;
                cells[firstCard.idx].classList.add("matched");
                cells[secondCard.idx].classList.add("matched");
                pairs++;
                $("gPairs").textContent = pairs + "/8";
                firstCard = null;
                secondCard = null;
                canFlip = true;
                if (pairs === 8) endGame();
            } else {
                setTimeout(function() {
                    cells[firstCard.idx].classList.remove("flipped");
                    cells[firstCard.idx].textContent = "";
                    cells[secondCard.idx].classList.remove("flipped");
                    cells[secondCard.idx].textContent = "";
                    firstCard = null;
                    secondCard = null;
                    canFlip = true;
                }, 800);
            }
        }
    }
    
    function startTimer() {
        seconds = 0;
        $("gTime").textContent = "0:00";
        if (timerInt) clearInterval(timerInt);
        timerInt = setInterval(function() {
            seconds++;
            $("gTime").textContent = formatTime(seconds);
        }, 1000);
    }
    
    function startGame() {
        if (!canPlay().ok) {
            showLimit();
            return;
        }
        moves = 0;
        pairs = 0;
        firstCard = null;
        secondCard = null;
        canFlip = true;
        $("gMoves").textContent = "0";
        $("gPairs").textContent = "0/8";
        buildGrid();
        show("gameBox");
        startTimer();
    }
    
    function endGame() {
        if (timerInt) clearInterval(timerInt);
        
        var s = getStats();
        s.games++;
        s.totalMoves += moves;
        var isRecord = !s.bestMoves || moves < s.bestMoves;
        if (isRecord) s.bestMoves = moves;
        setStats(s);
        
        useTry();
        
        $("resMoves").textContent = moves;
        $("resTime").textContent = formatTime(seconds);
        $("resPairs").textContent = "8";
        $("resRating").textContent = "Nivel: " + getRating(moves);
        
        if (isRecord) {
            $("resRecord").classList.remove("hidden");
        } else {
            $("resRecord").classList.add("hidden");
        }
        
        $("resBg").classList.remove("hidden");
        
        if (!canPlay().ok) {
            setTimeout(showLimit, 1500);
        }
    }
    
    // Initialize on DOM ready
    document.addEventListener("DOMContentLoaded", function() {
        getDeviceId();
        setupLogin();
        setupCreate();
        
        $("toCreate").onclick = function() {
            createPin = "";
            confirmPin = "";
            isConfirming = false;
            $("createTitle").textContent = "Crear PIN";
            $("createSub").textContent = "Escoge un PIN de 4 dÃ­gitos";
            setDots("c", 0);
            $("createMsg").textContent = "";
            show("createBox");
        };
        
        $("toLogin").onclick = function() {
            loginPin = "";
            setDots("d", 0);
            $("loginMsg").textContent = "";
            show("loginBox");
        };
        
        $("startBtn").onclick = function() {
            if (!canPlay().ok) {
                showLimit();
                return;
            }
            startGame();
        };
        
        $("logoutBtn").onclick = function() {
            loginPin = "";
            currentPin = "";
            setDots("d", 0);
            show("loginBox");
        };
        
        $("quitBtn").onclick = function() {
            if (timerInt) clearInterval(timerInt);
            loadDash();
        };
        
        $("againBtn").onclick = function() {
            $("resBg").classList.add("hidden");
            if (!canPlay().ok) {
                showLimit();
                return;
            }
            startGame();
        };
        
        $("menuBtn").onclick = function() {
            $("resBg").classList.add("hidden");
            loadDash();
        };
        
        $("upgradeBtn").onclick = function() {
            window.location.href = "mailto:support@akashic.works?subject=Pro%20Upgrade";
        };
        
        // Show login page on load
        show("loginBox");
        showBanner();
    });
})();
</script>
</body>
</html>
